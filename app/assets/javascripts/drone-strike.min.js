drone={version:"0.1.0"},drone.redrawAll=function(){drone._statsTable&&drone._statsTable.redraw(),drone._droneTargetMap&&drone._droneTargetMap.redraw()},drone.initializeSVG=function(e){var t=_.groupBy(e,function(e){return e.city}),n=d3.select("svg");for(var r in t){var i=t[r][0].xcoordinate,s=t[r][0].ycoordinate;n.append("g").attr("id",drone.utils.formatCityName(r)).attr("transform","translate("+i+","+s+")")}},drone.utils={},drone.utils.formatCityName=function(e){return e.replace(/_{2,}/g,"_")},drone.Data=function(t){var n=function(e){var t=(e.maxAq+e.minAq)/2,n=(e.maxTotal+e.minTotal)/2;e.killRatioAq=t/n||0;var r=(e.maxTaliban+e.minTaliban)/2;e.killRatioTaliban=r/n||0;var i=(e.maxForeigner+e.minForeigner)/2;e.killRatioForeigner=i/n||0;var s=(e.maxCivilian+e.minCivilian)/2;e.killRatioCivilian=s/n||0},r=function(e,t){return e.maxTotal+=+t.total_died_max,e.minTotal+=+t.total_died_min,e.maxAq+=+t.al_qaida_max,e.minAq+=+t.al_qaida_min,e.maxTaliban+=+t.taliban_max,e.minTaliban+=+t.taliban_min,e.maxForeigner+=+t.forigeners_max,e.minForeigner+=+t.forigeners_min,e.maxCivilian+=+t.civilians_max,e.minCivilian+=+t.civilians_min,n(e),e.maxInjured+=+t.injured_max,e.minInjured+=+t.injured_min,e},i=function(e,t){return e.maxTotal-=+t.total_died_max,e.minTotal-=+t.total_died_min,e.maxAq-=+t.al_qaida_max,e.minAq-=+t.al_qaida_min,e.maxTaliban-=+t.taliban_max,e.minTaliban-=+t.taliban_min,e.maxForeigner-=+t.forigeners_max,e.minForeigner-=+t.forigeners_min,e.maxCivilian-=+t.civilians_max,e.minCivilian-=+t.civilians_min,n(e),e.maxInjured-=+t.injured_max,e.minInjured-=+t.injured_min,e},s=function(){return{maxTotal:0,minTotal:0,maxAq:0,minAq:0,killRatioAq:0,maxTaliban:0,minTaliban:0,killRatioTaliban:0,maxForeigner:0,minForeigner:0,killRatioForeigner:0,maxCivilian:0,minCivilian:0,killRatioCivilian:0,maxInjured:0,minInjured:0}},o=function(e){return e.maxTotal},u=crossfilter(t),a=u.dimension(function(e){return e.incident_year}),f=u.dimension(function(e){return drone.utils.formatCityName(e.city)}),l=f.group().order(o).reduce(r,i,s),c;this.getYears=function(){return a},this.filterYearsInclusive=function(e,t){a.filterRange([e,(+t+1).toString()]),drone.redrawAll()},this.clearYearFilter=function(){a.filterAll()},this.getCities=function(){return f},this.getDeathsByCity=function(){return l.top(l.size())},this.selectCity=function(e){c=e},this.selectedCity=function(){return c},this.getActiveStats=function(){return this.hasCitySelected()?this.getSelectedCityStats():this.getTotalStats()},this.hasCitySelected=function(){return c!=null},this.getSelectedCityStats=function(){var e;return l.all().forEach(function(t){t.key==c&&(e=t.value)}),e},this.getTotalStats=function(){var t=s();return l.all().forEach(function(n){var r=n.value;for(e in r)t[e]+=r[e]}),n(t),t},this.clearCitySelection=function(){c=null}},drone.droneTargetMap=function(e,t){function a(){return r.selectAll("circle."+n).data(i.getDeathsByCity())}function f(e){e=e.attr("class",function(e){return n+" "+e.key}).classed("selected",function(e){return i.selectedCity()==e.key}).classed("deselected",function(e){return i.hasCitySelected()&&i.selectedCity()!=e.key}).attr("transform",function(e){return r.select("g#"+e.key).attr("transform")}).on("click",s.onclick),u>0&&(e=e.transition(u)),e.attr("r",function(e){return e.value.maxTotal==0?0:o(e.value.maxTotal)})}var n="drone_target",r=e,i=t,s={},o=d3.scale.linear().domain([0,1500]).range([10,80]),u=750;return s.onclick=function(e){var t=e.key;i.hasCitySelected()&&i.selectedCity()==t?i.clearCitySelection():i.selectCity(t),drone.redrawAll()},s.render=function(){var e=a();f(e.enter().append("circle")),e.exit().remove()},s.redraw=function(){var e=a();f(e)},s.transitionDuration=function(e){u=e},drone._droneTargetMap=s,s},drone.statsTable=function(e){function i(){o("Total"),o("Aq"),o("Taliban"),o("Foreigner"),o("Civilian"),o("Injured")}function s(){var e=t.selectedCity()?t.selectedCity():"Total",n=r.select("span.header");n.text(u(e))}function o(e){var n=t.getActiveStats(),i=r.select("span."+e);i.text(n["min"+e]+" - "+n["max"+e]);var s=r.select("span."+e+"Percentage");s.text(function(){var t=n["killRatio"+e];return Math.round(t*100)+"%"})}function u(e){var t=e.split("_"),n="";return t.forEach(function(e){n+=_.str.capitalize(e)+" "}),_.str.trim(n)}var t=e,n={},r;return n.render=function(){r=d3.select("#stats-table"),s(),i()},n.redraw=function(){s(),i()},drone._statsTable=n,n};